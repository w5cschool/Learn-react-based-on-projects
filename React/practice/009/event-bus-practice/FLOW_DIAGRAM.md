# ğŸ“Š Event Bus æ‰§è¡Œæµç¨‹å›¾

## 1ï¸âƒ£ ç»„ä»¶è®¢é˜…äº‹ä»¶ï¼ˆonï¼‰

```
ç»„ä»¶ B æŒ‚è½½
    â†“
useEventChat("sub-mox", { callback: handler })
    â†“
useEffect æ‰§è¡Œ
    â†“
eventBus.on("sub-mox", handler)
    â†“
EventBus å†…éƒ¨ï¼š
    â”œâ”€ æ£€æŸ¥ events.has("sub-mox")
    â”œâ”€ ä¸å­˜åœ¨ â†’ events.set("sub-mox", new Set())
    â””â”€ events.get("sub-mox").add(handler)
    â†“
å­˜å‚¨å®Œæˆï¼š
    events = {
      "sub-mox": Set([handler])
    }
```

## 2ï¸âƒ£ ç»„ä»¶å‘é€äº‹ä»¶ï¼ˆemitï¼‰

```
ç”¨æˆ·ç‚¹å‡»ç»„ä»¶ A çš„æŒ‰é’®
    â†“
emit({ name: "hello" })
    â†“
eventBus.emit("sub-mox", { name: "hello" })
    â†“
EventBus å†…éƒ¨ï¼š
    â”œâ”€ handlers = events.get("sub-mox")
    â”œâ”€ æ‰¾åˆ° Set([handler])
    â””â”€ handlers.forEach(handler => handler({ name: "hello" }))
    â†“
æ‰§è¡Œ handler({ name: "hello" })
    â†“
ç»„ä»¶ B çš„ callback è¢«è°ƒç”¨
    â†“
console.log("æ”¶åˆ°:", { name: "hello" })
```

## 3ï¸âƒ£ ç»„ä»¶å¸è½½ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰

```
ç»„ä»¶ B å¸è½½
    â†“
useEffect çš„æ¸…ç†å‡½æ•°æ‰§è¡Œ
    â†“
eventBus.off("sub-mox", handler)
    â†“
EventBus å†…éƒ¨ï¼š
    â””â”€ events.get("sub-mox").delete(handler)
    â†“
æ¸…ç†å®Œæˆï¼š
    events = {
      "sub-mox": Set([])  // ç©ºé›†åˆ
    }
```

## 4ï¸âƒ£ å®Œæ•´é€šä¿¡æµç¨‹ï¼ˆå¤šç»„ä»¶ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç»„ä»¶ A     â”‚  emit("sub-mox", data)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      EventBus               â”‚
â”‚                             â”‚
â”‚  events = {                 â”‚
â”‚    "sub-mox": Set([         â”‚
â”‚      handlerB,  â† ç»„ä»¶ B    â”‚
â”‚      handlerC,  â† ç»„ä»¶ C    â”‚
â”‚      handlerD   â† ç»„ä»¶ D    â”‚
â”‚    ])                       â”‚
â”‚  }                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»„ä»¶ B  â”‚ â”‚  ç»„ä»¶ C  â”‚ â”‚  ç»„ä»¶ D  â”‚
â”‚ handlerB â”‚ â”‚ handlerCâ”‚ â”‚ handlerDâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5ï¸âƒ£ æ•°æ®ç»“æ„å˜åŒ–è¿‡ç¨‹

### åˆå§‹çŠ¶æ€
```javascript
events = Map {}
```

### ç»„ä»¶ B è®¢é˜…
```javascript
events = Map {
  "sub-mox" => Set([handlerB])
}
```

### ç»„ä»¶ C ä¹Ÿè®¢é˜…
```javascript
events = Map {
  "sub-mox" => Set([handlerB, handlerC])
}
```

### ç»„ä»¶ A å‘é€æ¶ˆæ¯
```javascript
// events ä¸å˜ï¼Œåªæ˜¯æ‰§è¡Œæ‰€æœ‰ handler
handlerB(data)  // æ‰§è¡Œ
handlerC(data)  // æ‰§è¡Œ
```

### ç»„ä»¶ B å¸è½½
```javascript
events = Map {
  "sub-mox" => Set([handlerC])  // handlerB è¢«ç§»é™¤
}
```

## 6ï¸âƒ£ Hook æ‰§è¡Œæ—¶åº

```
ç»„ä»¶æŒ‚è½½
    â†“
useEventChat æ‰§è¡Œ
    â†“
useEffect æ‰§è¡Œï¼ˆä¾èµ–ï¼š[eventName, callback]ï¼‰
    â†“
eventBus.on()  â† è®¢é˜…äº‹ä»¶
    â†“
è¿”å› [emit] å‡½æ•°
    â†“
... ç»„ä»¶è¿è¡Œä¸­ ...
    â†“
ç»„ä»¶å¸è½½
    â†“
useEffect æ¸…ç†å‡½æ•°æ‰§è¡Œ
    â†“
eventBus.off()  â† å–æ¶ˆè®¢é˜…
```

## 7ï¸âƒ£ å†…å­˜ç®¡ç†æµç¨‹

```
âœ… æ­£ç¡®æµç¨‹ï¼ˆæ— æ³„æ¼ï¼‰ï¼š
ç»„ä»¶æŒ‚è½½ â†’ on() â†’ ç»„ä»¶å¸è½½ â†’ off() â†’ å†…å­˜é‡Šæ”¾

âŒ é”™è¯¯æµç¨‹ï¼ˆå†…å­˜æ³„æ¼ï¼‰ï¼š
ç»„ä»¶æŒ‚è½½ â†’ on() â†’ ç»„ä»¶å¸è½½ â†’ âŒ å¿˜è®° off() â†’ å†…å­˜æ³„æ¼
```

## 8ï¸âƒ£ è¯·æ±‚/å“åº”æ¨¡å¼æµç¨‹

```
å®¢æˆ·ç«¯ç»„ä»¶
    â†“
requestUser({ id: 123 })
    â†“
EventBus.request("getUser", { id: 123 })
    â†“
ç”Ÿæˆ requestId = "getUser:123456:0.789"
    â†“
åˆ›å»º Promiseï¼Œå­˜å‚¨åˆ° pendingRequests
    â†“
ç›‘å¬ "getUser:response:requestId"
    â†“
å‘é€ "getUser" äº‹ä»¶ï¼ˆæºå¸¦ _requestIdï¼‰
    â†“
    â†“
æœåŠ¡ç«¯ç»„ä»¶
    â†“
useEventRespond("getUser", handler)
    â†“
æ”¶åˆ°è¯·æ±‚ï¼Œæ‰§è¡Œ handler({ id: 123 })
    â†“
è¿”å›ç»“æœ { id: 123, name: "ç”¨æˆ· 123" }
    â†“
å‘é€ "getUser:response:requestId" äº‹ä»¶
    â†“
    â†“
å®¢æˆ·ç«¯ç»„ä»¶
    â†“
æ”¶åˆ°å“åº”äº‹ä»¶
    â†“
Promise resolve(result)
    â†“
è¿”å›ç»“æœç»™è°ƒç”¨è€…
```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

1. **è®¢é˜…æ—¶**ï¼šhandler è¢«æ·»åŠ åˆ° Set ä¸­
2. **å‘å¸ƒæ—¶**ï¼šéå† Setï¼Œæ‰§è¡Œæ‰€æœ‰ handler
3. **å¸è½½æ—¶**ï¼šä» Set ä¸­ç§»é™¤ handler
4. **Hook å°è£…**ï¼šè‡ªåŠ¨ç®¡ç†è®¢é˜…å’Œæ¸…ç†

---

è¿™äº›æµç¨‹å›¾å¸®åŠ©ä½ ç†è§£ Event Bus çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹ï¼ğŸš€

